<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêâ BDH Chat - Talk to Baby Dragon Hatchling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0;
            padding: 0;
            background: #000;
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .video-background video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 1;
        }

        body > * {
            position: relative;
            z-index: 2;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .brand-logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: contain;
            background: #000000;
            border: 1px solid rgba(251, 191, 36, 0.4);
            padding: 6px;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.2);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .warning-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #fbbf24;
        }

        .warning-banner.show {
            display: flex;
        }

        .warning-banner .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #92400e;
        }

        .chat-container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar h3 {
            padding: 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .example-list {
            flex: 1;
            overflow-y: auto;
        }

        .example-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
        }

        .example-item:hover {
            background: #f9fafb;
        }

        .example-item .title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .example-item .preview {
            font-size: 0.9em;
            color: #6b7280;
            font-style: italic;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6b7280;
        }

        .welcome-screen .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .welcome-screen h2 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 2em;
        }

        .welcome-screen p {
            max-width: 500px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: #000000;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000000;
        }

        .avatar-initial {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: 600;
            color: #f8fafc;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.user .message-avatar {
            border: none;
            background: transparent;
        }

        .message.assistant .message-avatar {
            border-color: rgba(251, 191, 36, 0.45);
        }

        .message-content {
            background: #f3f4f6;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: #f3f4f6;
            color: #1f2937;
        }

        .message-time {
            font-size: 0.75em;
            color: #9ca3af;
            margin-top: 5px;
        }

        .input-area {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            padding: 15px 60px 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1em;
            font-family: inherit;
            resize: none;
            max-height: 150px;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .settings-toggle {
            position: absolute;
            right: 15px;
            bottom: 15px;
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.3s;
        }

        .settings-toggle:hover {
            color: #667eea;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .settings-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: #f9fafb;
            border-radius: 15px;
            margin-top: 0;
        }

        .settings-panel.open {
            max-height: 400px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #e5e7eb;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }

        .setting-item .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item input[type="range"] {
            flex: 1;
        }

        .setting-item .value-display {
            min-width: 50px;
            text-align: center;
            padding: 5px 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .info-tooltip {
            display: inline-block;
            background: #3b82f6;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            text-align: center;
            font-size: 0.7em;
            line-height: 16px;
            cursor: help;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .message {
                max-width: 90%;
            }
        }

        .model-warning {
            background: #fee2e2;
            border: 2px solid #fca5a5;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #991b1b;
        }

        .model-warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .train-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
        }

        .train-button:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <!-- Background Video -->
    <div class="video-background">
        <video autoplay muted loop playsinline>
            <source src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafybeideydseywzyb7wso574upvbzw3prqbf3uvtw62sz2hitan4d3dpeq" type="video/mp4">
        </video>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>
            <img src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafkreigkcpqnrvoxuckstiwkedz4sbivmliajhxhk3cysrugmftsbizple" alt="BDH dragon logo" class="brand-logo">
            <span>Baby Dragon Hatchling Chat</span>
        </h1>
        <div class="status-badge">
            <span class="status-dot"></span>
            <span id="modelStatus">Loading...</span>
        </div>
    </div>

    <!-- Warning Banner -->
    <div class="warning-banner" id="warningBanner">
        <div>
            <strong>‚ö†Ô∏è Model Not Trained!</strong> 
            The model needs training to generate coherent text. Currently generating random output.
            <a href="#" onclick="showTrainingGuide(); return false;" style="color: #667eea; text-decoration: underline; margin-left: 10px;">Learn how to train</a>
        </div>
        <button class="close-btn" onclick="closeWarning()">√ó</button>
    </div>

    <!-- Main Container -->
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3>üí° Example Prompts</h3>
            <div class="example-list" id="exampleList">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="icon">
                        <img src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafkreigkcpqnrvoxuckstiwkedz4sbivmliajhxhk3cysrugmftsbizple" alt="Dragon logo" style="width: 96px; height: 96px; border-radius: 12px; background: #000000; border: 1px solid rgba(251, 191, 36, 0.45); padding: 12px; box-shadow: 0 12px 24px rgba(251, 191, 36, 0.18);">
                    </div>
                    <h2>Chat with Baby Dragon Hatchling</h2>
                    <p>BDH is a biologically-inspired AI that mimics how the brain processes language. Unlike traditional AI, it uses locally-interacting neurons with Hebbian learning!</p>
                    <div id="modelInfo" style="margin-top: 20px;">
                        <p style="color: #6b7280;">Checking model status...</p>
                    </div>
                    <p style="margin-top: 20px; font-size: 0.9em;">Try one of the example prompts or type your own message below!</p>
                </div>
            </div>

            <div class="input-area">
                <div class="settings-panel" id="settingsPanel">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>
                                Temperature
                                <span class="info-tooltip" title="Controls randomness. Lower = focused, Higher = creative">?</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.8" oninput="updateSetting('temperature')">
                                <span class="value-display" id="temperatureValue">0.8</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>
                                Top-K
                                <span class="info-tooltip" title="Limits choices to K most likely tokens">?</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="topK" min="1" max="100" value="40" oninput="updateSetting('topK')">
                                <span class="value-display" id="topKValue">40</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>
                                Max Length
                                <span class="info-tooltip" title="Maximum characters to generate">?</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="maxTokens" min="20" max="300" value="100" oninput="updateSetting('maxTokens')">
                                <span class="value-display" id="maxTokensValue">100</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Type your message here... (e.g., 'Tell me a story about')" 
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <button class="settings-toggle" onclick="toggleSettings()" title="Adjust settings">
                            ‚öôÔ∏è
                        </button>
                    </div>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isModelTrained = false;

        const ASSET_URLS = {
            chatgpt: 'https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafkreibytn4xdxnlapnsujbstv7fbc43zdqpe433fbalm5ilov7ibmd3oy',
            dragon: 'https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafkreigkcpqnrvoxuckstiwkedz4sbivmliajhxhk3cysrugmftsbizple'
        };

        function getAvatarMarkup(role) {
            if (role === 'assistant') {
                return `<img src="${ASSET_URLS.dragon}" alt="BDH dragon logo" class="avatar-image">`;
            }
            return '<span class="avatar-initial">YOU</span>';
        }

        // Initialize
        window.onload = function() {
            checkModelStatus();
            loadExamples();
            
            // Auto-resize textarea
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        };

        function checkModelStatus() {
            fetch('/api/train-status')
                .then(response => response.json())
                .then(data => {
                    isModelTrained = data.trained;
                    const statusEl = document.getElementById('modelStatus');
                    const modelInfo = document.getElementById('modelInfo');
                    const warningBanner = document.getElementById('warningBanner');
                    
                    if (data.trained) {
                        statusEl.textContent = 'Model Ready ‚úì';
                        if (modelInfo) {
                            modelInfo.innerHTML = `
                                <div style="background: #d1fae5; padding: 15px; border-radius: 10px; border: 2px solid #10b981;">
                                    <strong style="color: #065f46;">‚úì Trained Model Loaded</strong>
                                    <p style="color: #047857; margin-top: 5px; font-size: 0.9em;">
                                        The model has been trained and will generate coherent text!
                                    </p>
                                </div>
                            `;
                        }
                    } else {
                        statusEl.textContent = 'Model Untrained ‚ö†Ô∏è';
                        warningBanner.classList.add('show');
                        if (modelInfo) {
                            modelInfo.innerHTML = `
                                <div class="model-warning">
                                    <strong>‚ö†Ô∏è Model Not Trained</strong>
                                    <p style="margin-top: 5px; font-size: 0.9em;">
                                        The model is using random initialization and will generate random characters.<br>
                                        To get meaningful text, you need to train the model first.
                                    </p>
                                    <button class="train-button" onclick="showTrainingGuide()">
                                        üìö How to Train the Model
                                    </button>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking model status:', error);
                    document.getElementById('modelStatus').textContent = 'Error';
                });
        }

        function loadExamples() {
            fetch('/api/examples')
                .then(response => response.json())
                .then(examples => {
                    const container = document.getElementById('exampleList');
                    container.innerHTML = examples.map(ex => `
                        <div class="example-item" onclick='loadExample(${JSON.stringify(ex)})'>
                            <div class="title">${ex.name}</div>
                            <div class="preview">"${ex.prompt}"</div>
                        </div>
                    `).join('');
                })
                .catch(error => console.error('Error loading examples:', error));
        }

        function loadExample(example) {
            document.getElementById('messageInput').value = example.prompt;
            document.getElementById('temperature').value = example.temperature;
            document.getElementById('topK').value = example.top_k;
            document.getElementById('maxTokens').value = example.max_new_tokens;
            
            updateSetting('temperature');
            updateSetting('topK');
            updateSetting('maxTokens');
            
            document.getElementById('messageInput').focus();
        }

        function updateSetting(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');
            display.textContent = slider.value;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
        }

        function closeWarning() {
            document.getElementById('warningBanner').classList.remove('show');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Hide welcome screen
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // Add user message
            addMessage('user', message);
            
            // Clear input and reset height
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            addTypingIndicator();
            
            // Disable send button
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            
            // Get settings
            const temperature = parseFloat(document.getElementById('temperature').value);
            const topK = parseInt(document.getElementById('topK').value);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            // Send to API
            fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: message,
                    temperature: temperature,
                    top_k: topK,
                    max_new_tokens: maxTokens
                })
            })
            .then(response => response.json())
            .then(data => {
                removeTypingIndicator();
                
                if (data.success) {
                    // Show only the generated text (not the full output)
                    const generatedText = data.generated_text || data.output.substring(message.length);
                    addMessage('assistant', generatedText);
                } else {
                    addMessage('assistant', '‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                removeTypingIndicator();
                addMessage('assistant', '‚ùå Network error. Please make sure the server is running.');
            })
            .finally(() => {
                sendButton.disabled = false;
            });
        }

        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${getAvatarMarkup(role)}</div>
                <div>
                    <div class="message-content">${escapeHtml(content)}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            conversationHistory.push({ role, content, time });
        }

        function addTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">${getAvatarMarkup('assistant')}</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showTrainingGuide() {
            addMessage('assistant', `üìö How to Train the BDH Model:

1. Open a terminal in the project directory
2. Run: python train.py
3. Wait 5-10 minutes for training to complete
4. Refresh this page

The model will train on Shakespeare's works and learn to generate coherent text!

After training, you'll see much better results. Right now, the model is untrained and generates random output.`);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
